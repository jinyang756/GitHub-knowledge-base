name: 金融市场分析自动化

on:
  schedule:
    # 每天早上8点运行（北京时间）
    - cron: '0 0 * * *'
  workflow_dispatch:

jobs:
  run_market_analysis:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          fi
      
      - name: Debug information
        run: |
          echo "Current directory: $(pwd)"
          echo "Files in directory: $(ls -la)"
          echo "Python version: $(python --version)"
          echo "Pip version: $(pip --version)"
      
      - name: Run market analysis with error handling
        run: |
          set -e
          python automatic_market_update.py once || {
            echo "Market analysis failed, checking logs..."
            if [ -f market_update.log ]; then
              cat market_update.log
            fi
            exit 1
          }
      
      - name: Check if today is trading day
        id: trading_day
        run: |
          # 检查是否为周一至周五
          if [ $(date +%u) -lt 6 ]; then
            echo "trading_day=true" >> $GITHUB_ENV
          else
            echo "trading_day=false" >> $GITHUB_ENV
          fi
      
      - name: Run trading analysis (only on trading days)
        if: env.trading_day == 'true'
        run: |
          set -e
          python automatic_trading_analysis.py test || {
            echo "Trading analysis failed, checking logs..."
            if [ -f trading_analysis.log ]; then
              cat trading_analysis.log
            fi
            exit 1
          }
      
      - name: Commit and push changes with retry
        run: |
          git config --global user.name 'GitHub Actions'
          git config --global user.email 'actions@github.com'
          # 检查是否有变更需要提交
          if [ -n "$(git status -s)" ]; then
            echo "有变更需要提交..."
            git add .
            git commit -m '自动更新金融市场分析报告'
            # 尝试推送，包含重试机制
            for i in {1..3}; do
              git push && break || {
                echo "推送失败，等待5秒后重试 ($i/3)..."
                sleep 5
              }
            done
          else
            echo "没有检测到变更，跳过提交和推送步骤"
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}